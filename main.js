var E=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var k=(h,e)=>{for(var t in e)E(h,t,{get:e[t],enumerable:!0})},L=(h,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of D(e))!P.call(h,o)&&o!==t&&E(h,o,{get:()=>e[o],enumerable:!(i=S(e,o))||i.enumerable});return h};var T=h=>L(E({},"__esModule",{value:!0}),h);var C={};k(C,{default:()=>M});module.exports=T(C);var u=require("obsidian");var g=require("obsidian"),y=class extends g.Modal{constructor(e,t,i,o){super(e),this.plugin=t,this.pluginId=i,this.onSelect=o,this.models=[],this.filteredModels=[],this.favorites=[...t.settings.favoriteModels||[]],this.balance="Loading...",this.filters={search:"",modality:"any",provider:[],context:"any",maxPrice:10}}async onOpen(){this.modalEl.addClass("or-modal"),this.plugin.fetchCredits().then(r=>{this.balance=r?`$${r}`:"Unknown",this.balanceEl&&this.balanceEl.setText(`Balance: ${this.balance}`)});let{contentEl:e}=this;e.empty();let t=e.createDiv({cls:"or-container"}),i=t.createDiv({cls:"or-sidebar"});i.createEl("h3",{text:"Select Model",cls:"or-sidebar-title"}),i.createDiv({text:this.pluginId,cls:"or-sidebar-subtitle"}),i.createEl("input",{cls:"or-search",attr:{placeholder:"Search models..."}}).addEventListener("input",r=>{this.filters.search=r.target.value.toLowerCase(),this.applyFilters()});let a=i.createDiv({cls:"or-filter-group"});a.createDiv({text:"Max Price ($/1M)",cls:"or-filter-label"});let n=a.createDiv({text:"$10.00",cls:"or-filter-value"});a.createEl("input",{type:"range",cls:"or-slider",attr:{min:"0",max:"10",step:"0.1",value:"10"}}).addEventListener("input",r=>{this.filters.maxPrice=parseFloat(r.target.value),n.setText(this.filters.maxPrice>=10?"$10.00+":`$${this.filters.maxPrice.toFixed(2)}`),this.applyFilters()}),this.createAccordion(i,"Modalities",[{label:"Text",value:"text"},{label:"Image (Vision)",value:"image"}],"modality",!0),this.createAccordion(i,"Providers",[{label:"OpenAI",value:"openai"},{label:"Anthropic",value:"anthropic"},{label:"Google",value:"google"},{label:"Mistral",value:"mistral"},{label:"Meta (Llama)",value:"meta"}],"provider",!1),this.createAccordion(i,"Context Length",[{label:"Any",value:"any",checked:!0},{label:"32k+",value:"32k"},{label:"128k+",value:"128k"}],"context",!0);let c=t.createDiv({cls:"or-catalog"}),d=c.createDiv({cls:"or-catalog-header"});this.countSpan=d.createSpan({text:"Loading...",cls:"or-catalog-title"}),this.balanceEl=d.createDiv({text:"Balance: ...",cls:"or-balance"}),this.modelList=c.createDiv({cls:"or-model-list"});let s=t.createDiv({cls:"or-saved"});s.createDiv({text:"MY SAVED MODELS",cls:"or-saved-title"}),s.addEventListener("dragover",r=>{r.preventDefault(),s.addClass("drag-over")}),s.addEventListener("dragleave",r=>{r.preventDefault(),s.removeClass("drag-over")}),s.addEventListener("drop",r=>{var v;r.preventDefault(),s.removeClass("drag-over");let l=(v=r.dataTransfer)==null?void 0:v.getData("text/plain");l&&!this.favorites.includes(l)?this.toggleFavorite(l):l&&new g.Notice("Model already in favorites")}),this.savedList=s.createDiv({cls:"or-saved-list"}),this.renderSaved(),this.fetchModels()}createAccordion(e,t,i,o,a){let n=e.createDiv({cls:"or-accordion open"}),p=n.createDiv({cls:"or-accordion-header"});p.createSpan({text:t}),p.innerHTML+='<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>',p.addEventListener("click",()=>n.classList.toggle("open"));let c=n.createDiv({cls:"or-accordion-body"});i.forEach(d=>{let s=c.createEl("label",{cls:"or-checkbox-row"}),r=s.createEl("input",{type:a?"radio":"checkbox",attr:{name:o}});d.checked&&(r.checked=!0),s.createSpan({text:d.label}),r.addEventListener("change",()=>{if(a)this.filters[o]=d.value;else{let l=this.filters[o];r.checked?l.push(d.value):this.filters[o]=l.filter(v=>v!==d.value)}this.applyFilters()})})}async fetchModels(){try{let e=await(0,g.requestUrl)({url:"https://openrouter.ai/api/v1/models",method:"GET"});e.status===200?(this.models=e.json.data,this.applyFilters()):new g.Notice("Failed to fetch models")}catch(e){console.error(e),new g.Notice("Error fetching models: "+e.message)}}applyFilters(){this.filteredModels=this.models.filter(e=>{if(this.filters.search&&!e.id.toLowerCase().includes(this.filters.search)&&!e.name.toLowerCase().includes(this.filters.search)||this.filters.modality==="image"&&!(e.id.includes("vision")||e.id.includes("gpt-4-turbo")||e.id.includes("claude-3"))||this.filters.provider.length>0&&!this.filters.provider.some(i=>e.id.startsWith(i)))return!1;if(this.filters.context!=="any"){let t=e.context_length||0;if(this.filters.context==="32k"&&t<32e3||this.filters.context==="128k"&&t<128e3)return!1}return!(this.filters.maxPrice<10&&(e.pricing?parseFloat(e.pricing.prompt)*1e6:0)>this.filters.maxPrice)}),this.countSpan.setText(`${this.filteredModels.length} Models`),this.renderCatalog()}renderCatalog(){this.modelList.empty(),this.filteredModels.slice(0,100).forEach(t=>{let i=this.modelList.createDiv({cls:"or-model-card"});i.setAttribute("draggable","true"),i.addEventListener("dragstart",s=>{var r;(r=s.dataTransfer)==null||r.setData("text/plain",t.id),s.dataTransfer&&(s.dataTransfer.effectAllowed="copy"),i.addClass("dragging")}),i.addEventListener("dragend",()=>i.removeClass("dragging"));let o=i.createDiv({cls:"or-model-info"}),a=o.createDiv({cls:"or-model-name"});a.createSpan({text:t.name}),(t.id.includes("vision")||t.id.includes("gemini")||t.id.includes("claude-3"))&&a.createSpan({text:"\u{1F441}\uFE0F",attr:{title:"Multimodal"}});let n=o.createDiv({cls:"or-model-meta"});if(n.createSpan({text:t.context_length?Math.round(t.context_length/1e3)+"k":"?"}),t.id.endsWith(":free"))n.createSpan({text:"FREE",cls:"or-tag-free"});else{let s=t.pricing?(parseFloat(t.pricing.prompt)*1e6).toFixed(2):"?";n.createSpan({text:`$${s}/M`,cls:"or-tag-paid"})}o.createDiv({text:t.id,cls:"or-model-id"}),o.addEventListener("click",()=>this.selectModel(t.id));let c=this.favorites.includes(t.id),d=i.createSpan({text:c?"\u2B50":"\u2606",cls:"or-fav-btn",attr:{title:c?"Remove from Favorites":"Add to Favorites"}});d.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")}),i.addEventListener("contextmenu",s=>{s.preventDefault(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")})})}renderSaved(){this.savedList.empty(),this.favorites.forEach(e=>{var n;let t=this.savedList.createDiv({cls:"or-saved-item"}),i=t.createDiv();i.createDiv({text:e.split("/").pop()||e,cls:"or-saved-item-name"});let o=(n=this.plugin.settings.modelContextLengths)==null?void 0:n[e];o&&i.createDiv({text:`\u{1F4CF} ${Math.round(o/1e3)}k`,cls:"or-saved-item-ctx"});let a=t.createDiv({cls:"or-saved-item-remove clickable-icon",attr:{"aria-label":"Remove"}});(0,g.setIcon)(a,"cross"),a.addEventListener("click",p=>{p.stopPropagation(),this.toggleFavorite(e)}),t.addEventListener("click",()=>this.selectModel(e))})}toggleFavorite(e){if(this.favorites.includes(e))this.favorites=this.favorites.filter(t=>t!==e),this.plugin.removeFavorite(e);else{this.favorites.push(e);let t=this.models.find(i=>i.id===e);this.plugin.addFavorite(e,(t==null?void 0:t.context_length)||null),this.pluginId&&this.pluginId!=="settings"&&(this.plugin.setModel(this.pluginId,e),console.log("Also set as plugin model:",this.pluginId,"->",e))}this.renderSaved(),new g.Notice(this.favorites.includes(e)?"Saved model":"Removed model")}selectModel(e){console.log("selectModel called:",e,"pluginId:",this.pluginId),this.plugin.setModel(this.pluginId,e),this.onSelect(e),this.close(),new g.Notice(`Selected: ${e.split("/").pop()}`)}onClose(){this.contentEl.empty(),this.modalEl.removeClass("or-modal")}};var x=require("obsidian"),b=class extends x.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"\u{1F310} OpenRouter Provider Settings"}),new x.Setting(e).setName("API Key").setDesc("Your OpenRouter API key (shared across all AI plugins)").addText(s=>s.setPlaceholder("sk-or-...").setValue(this.plugin.settings.apiKey).onChange(async r=>{this.plugin.settings.apiKey=r,await this.plugin.saveSettings()}));let t=e.createDiv({attr:{style:"margin-bottom: 16px; color: var(--text-success);"}});t.setText("Checking balance..."),this.plugin.fetchCredits().then(s=>{t.setText(s?`\u{1F4B3} Balance: $${s}`:"\u{1F4B3} Balance: Unknown")}),e.createEl("h3",{text:"\u2B50 Favorite Models"});let i=e.createDiv({attr:{style:"margin-bottom: 16px;"}}),o=this.plugin.getFavorites();o.length===0?i.createDiv({text:"No favorites saved yet.",attr:{style:"color: var(--text-muted); font-style: italic;"}}):o.forEach(s=>{let r=s.split("/"),l=r.length>1?r[0]:"",v=r.length>1?r.slice(1).join("/"):s,f=i.createDiv({cls:"openrouter-list-row"});f.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 4px; background: var(--background-secondary); border-radius: 4px; gap: 12px;";let m=f.createEl("span");if(m.textContent=v,m.style.cssText="font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis;",l){let w=f.createEl("span");w.textContent=l,w.style.cssText="color: var(--text-muted); font-size: 0.8em; flex-shrink: 0;"}}),new x.Setting(e).addButton(s=>s.setButtonText("Manage Models").onClick(()=>{this.plugin.openModelSelector("settings",()=>{this.display()})})),e.createEl("h3",{text:"\u{1F50C} Plugin Model Assignments"});let a=e.createDiv({attr:{style:"margin-bottom: 16px;"}}),n=this.plugin.settings.pluginModels||{},p=Object.entries(n).filter(([s])=>s!=="settings");p.length===0?a.createDiv({text:"No plugins have selected a model yet.",attr:{style:"color: var(--text-muted); font-style: italic;"}}):p.forEach(([s,r])=>{let l=r.split("/").pop(),v=a.createDiv({cls:"openrouter-list-row"});v.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 4px; background: var(--background-secondary); border-radius: 4px; gap: 12px;";let f=v.createEl("span");f.textContent=s,f.style.cssText="font-weight: bold; flex: 1;";let m=v.createEl("span");m.textContent=l||r,m.style.cssText="color: var(--text-accent); flex-shrink: 0;"}),e.createEl("h3",{text:"\u{1F527} Debug Info"});let c=e.createDiv({attr:{style:"padding: 8px; background: var(--background-secondary); border-radius: 4px; font-family: monospace; font-size: 0.8em;"}});c.createDiv({text:"Raw pluginModels:"}),c.createDiv({text:JSON.stringify(n,null,2),attr:{style:"white-space: pre; margin-left: 12px; color: var(--text-muted);"}});let d=["ai-ocr-formatter","ai-flashcards"];c.createDiv({text:"Checking AI plugins:",attr:{style:"margin-top: 8px;"}}),d.forEach(s=>{let l=this.app.plugins.getPlugin(s)?"\u2705 Loaded":"\u274C Not loaded";c.createDiv({text:`  ${s}: ${l}`,attr:{style:"margin-left: 12px;"}})})}};var F={apiKey:"",apiUrl:"https://openrouter.ai/api/v1/chat/completions",favoriteModels:["google/gemini-2.0-flash-exp:free","openai/gpt-4o-mini","anthropic/claude-3-haiku"],modelContextLengths:{},pluginModels:{}},M=class extends u.Plugin{async onload(){await this.loadSettings(),window.openrouterProvider=this,this.addSettingTab(new b(this.app,this)),this.addCommand({id:"open-settings",name:"Open OpenRouter Settings",callback:()=>{this.app.setting.open(),this.app.setting.openTabById("openrouter-provider")}}),console.log("OpenRouter Provider loaded")}onunload(){delete window.openrouterProvider}getApiKey(){return this.settings.apiKey}async setApiKey(e){this.settings.apiKey=e,await this.saveSettings()}getModel(e){return this.settings.pluginModels[e]||this.settings.favoriteModels[0]||"google/gemini-2.0-flash-exp:free"}async setModel(e,t){this.settings.pluginModels[e]=t,await this.saveSettings(),console.log("Plugin model saved:",e,"->",t,"All:",this.settings.pluginModels)}getFavorites(){return this.settings.favoriteModels||[]}async addFavorite(e,t=null){let i=this.settings.favoriteModels;i.indexOf(e)===-1&&i.push(e),t&&(this.settings.modelContextLengths[e]=t),await this.saveSettings(),console.log("Favorites saved:",this.settings.favoriteModels)}async removeFavorite(e){this.settings.favoriteModels=this.settings.favoriteModels.filter(t=>t!==e),await this.saveSettings(),console.log("Favorites after remove:",this.settings.favoriteModels)}async fetchCredits(){var e,t,i,o;if(!this.settings.apiKey)return null;try{let[a,n]=await Promise.all([(0,u.requestUrl)({url:"https://openrouter.ai/api/v1/credits",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}}),(0,u.requestUrl)({url:"https://openrouter.ai/api/v1/auth/key",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}})]),p=0;a.status===200&&(p=((t=(e=a.json)==null?void 0:e.data)==null?void 0:t.total_credits)||0);let c=1/0;return n.status===200&&((o=(i=n.json)==null?void 0:i.data)==null?void 0:o.limit)!==null&&(c=Math.max(0,(n.json.data.limit||0)-(n.json.data.usage||0))),Math.min(p,c).toFixed(2)}catch(a){return console.error("Failed to fetch credits",a),null}}openModelSelector(e,t){new y(this.app,this,e,t).open()}async fetchWithRetry(e,t=3,i=2e3){var o,a,n,p,c;for(let d=0;d<t;d++)try{let s=await(0,u.requestUrl)({url:this.settings.apiUrl,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Obsidian OpenRouter Provider"},body:JSON.stringify(e)});if(s.status===429){new u.Notice(`\u26A0\uFE0F Rate limit! Waiting ${i/1e3}s...`),await new Promise(r=>setTimeout(r,i)),i*=2;continue}if(s.status>=400){let r=`API Error ${s.status}`;try{let l=s.json;(o=l==null?void 0:l.error)!=null&&o.message&&(r+=`: ${l.error.message}`)}catch(l){}throw new Error(r)}return(c=(p=(n=(a=s.json)==null?void 0:a.choices)==null?void 0:n[0])==null?void 0:p.message)!=null&&c.content&&(s.json.choices[0].message.content=s.json.choices[0].message.content.replace(/<think>[\s\S]*?<\/think>/gi,"").trim()),s}catch(s){if(d===t-1)throw s;await new Promise(r=>setTimeout(r,i)),i*=1.5}}async loadSettings(){this.settings=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
