var M=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var w=(h,e)=>{for(var t in e)M(h,t,{get:e[t],enumerable:!0})},P=(h,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of E(e))!D.call(h,i)&&i!==t&&M(h,i,{get:()=>e[i],enumerable:!(s=S(e,i))||s.enumerable});return h};var L=h=>P(M({},"__esModule",{value:!0}),h);var C={};w(C,{default:()=>y});module.exports=L(C);var u=require("obsidian");var p=require("obsidian"),m=class extends p.Modal{constructor(e,t,s,i){super(e),this.plugin=t,this.pluginId=s,this.onSelect=i,this.models=[],this.filteredModels=[],this.favorites=[...t.settings.favoriteModels||[]],this.balance="Loading...",this.filters={search:"",modality:"any",provider:[],context:"any",maxPrice:10}}async onOpen(){this.modalEl.addClass("or-modal"),this.plugin.fetchCredits().then(r=>{this.balance=r?`$${r}`:"Unknown",this.balanceEl&&this.balanceEl.setText(`Balance: ${this.balance}`)});let{contentEl:e}=this;e.empty();let t=e.createDiv({cls:"or-container"}),s=t.createDiv({cls:"or-sidebar"});s.createEl("h3",{text:"Select Model",cls:"or-sidebar-title"}),s.createDiv({text:this.pluginId,cls:"or-sidebar-subtitle"}),s.createEl("input",{cls:"or-search",attr:{placeholder:"Search models..."}}).addEventListener("input",r=>{this.filters.search=r.target.value.toLowerCase(),this.applyFilters()});let a=s.createDiv({cls:"or-filter-group"});a.createDiv({text:"Max Price ($/1M)",cls:"or-filter-label"});let o=a.createDiv({text:"$10.00",cls:"or-filter-value"});a.createEl("input",{type:"range",cls:"or-slider",attr:{min:"0",max:"10",step:"0.1",value:"10"}}).addEventListener("input",r=>{this.filters.maxPrice=parseFloat(r.target.value),o.setText(this.filters.maxPrice>=10?"$10.00+":`$${this.filters.maxPrice.toFixed(2)}`),this.applyFilters()}),this.createAccordion(s,"Modalities",[{label:"Text",value:"text"},{label:"Image (Vision)",value:"image"}],"modality",!0),this.createAccordion(s,"Providers",[{label:"OpenAI",value:"openai"},{label:"Anthropic",value:"anthropic"},{label:"Google",value:"google"},{label:"Mistral",value:"mistral"},{label:"Meta (Llama)",value:"meta"}],"provider",!1),this.createAccordion(s,"Context Length",[{label:"Any",value:"any",checked:!0},{label:"32k+",value:"32k"},{label:"128k+",value:"128k"}],"context",!0);let c=t.createDiv({cls:"or-catalog"}),d=c.createDiv({cls:"or-catalog-header"});this.countSpan=d.createSpan({text:"Loading...",cls:"or-catalog-title"}),this.balanceEl=d.createDiv({text:"Balance: ...",cls:"or-balance"}),this.modelList=c.createDiv({cls:"or-model-list"});let n=t.createDiv({cls:"or-saved"});n.createDiv({text:"MY SAVED MODELS",cls:"or-saved-title"}),n.addEventListener("dragover",r=>{r.preventDefault(),n.addClass("drag-over")}),n.addEventListener("dragleave",r=>{r.preventDefault(),n.removeClass("drag-over")}),n.addEventListener("drop",r=>{var f;r.preventDefault(),n.removeClass("drag-over");let g=(f=r.dataTransfer)==null?void 0:f.getData("text/plain");g&&!this.favorites.includes(g)?this.toggleFavorite(g):g&&new p.Notice("Model already in favorites")}),this.savedList=n.createDiv({cls:"or-saved-list"}),this.renderSaved(),this.fetchModels()}createAccordion(e,t,s,i,a){let o=e.createDiv({cls:"or-accordion open"}),l=o.createDiv({cls:"or-accordion-header"});l.createSpan({text:t}),l.innerHTML+='<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>',l.addEventListener("click",()=>o.classList.toggle("open"));let c=o.createDiv({cls:"or-accordion-body"});s.forEach(d=>{let n=c.createEl("label",{cls:"or-checkbox-row"}),r=n.createEl("input",{type:a?"radio":"checkbox",attr:{name:i}});d.checked&&(r.checked=!0),n.createSpan({text:d.label}),r.addEventListener("change",()=>{if(a)this.filters[i]=d.value;else{let g=this.filters[i];r.checked?g.push(d.value):this.filters[i]=g.filter(f=>f!==d.value)}this.applyFilters()})})}async fetchModels(){try{let e=await(0,p.requestUrl)({url:"https://openrouter.ai/api/v1/models",method:"GET"});e.status===200?(this.models=e.json.data,this.applyFilters()):new p.Notice("Failed to fetch models")}catch(e){console.error(e),new p.Notice("Error fetching models: "+e.message)}}applyFilters(){this.filteredModels=this.models.filter(e=>{if(this.filters.search&&!e.id.toLowerCase().includes(this.filters.search)&&!e.name.toLowerCase().includes(this.filters.search)||this.filters.modality==="image"&&!(e.id.includes("vision")||e.id.includes("gpt-4-turbo")||e.id.includes("claude-3"))||this.filters.provider.length>0&&!this.filters.provider.some(s=>e.id.startsWith(s)))return!1;if(this.filters.context!=="any"){let t=e.context_length||0;if(this.filters.context==="32k"&&t<32e3||this.filters.context==="128k"&&t<128e3)return!1}return!(this.filters.maxPrice<10&&(e.pricing?parseFloat(e.pricing.prompt)*1e6:0)>this.filters.maxPrice)}),this.countSpan.setText(`${this.filteredModels.length} Models`),this.renderCatalog()}renderCatalog(){this.modelList.empty(),this.filteredModels.slice(0,100).forEach(t=>{let s=this.modelList.createDiv({cls:"or-model-card"});s.setAttribute("draggable","true"),s.addEventListener("dragstart",n=>{var r;(r=n.dataTransfer)==null||r.setData("text/plain",t.id),n.dataTransfer&&(n.dataTransfer.effectAllowed="copy"),s.addClass("dragging")}),s.addEventListener("dragend",()=>s.removeClass("dragging"));let i=s.createDiv({cls:"or-model-info"}),a=i.createDiv({cls:"or-model-name"});a.createSpan({text:t.name}),(t.id.includes("vision")||t.id.includes("gemini")||t.id.includes("claude-3"))&&a.createSpan({text:"\u{1F441}\uFE0F",attr:{title:"Multimodal"}});let o=i.createDiv({cls:"or-model-meta"});if(o.createSpan({text:t.context_length?Math.round(t.context_length/1e3)+"k":"?"}),t.id.endsWith(":free"))o.createSpan({text:"FREE",cls:"or-tag-free"});else{let n=t.pricing?(parseFloat(t.pricing.prompt)*1e6).toFixed(2):"?";o.createSpan({text:`$${n}/M`,cls:"or-tag-paid"})}i.createDiv({text:t.id,cls:"or-model-id"}),i.addEventListener("click",()=>this.selectModel(t.id));let c=this.favorites.includes(t.id),d=s.createSpan({text:c?"\u2B50":"\u2606",cls:"or-fav-btn",attr:{title:c?"Remove from Favorites":"Add to Favorites"}});d.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")}),s.addEventListener("contextmenu",n=>{n.preventDefault(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")})})}renderSaved(){this.savedList.empty(),this.favorites.forEach(e=>{var o;let t=this.savedList.createDiv({cls:"or-saved-item"}),s=t.createDiv();s.createDiv({text:e.split("/").pop()||e,cls:"or-saved-item-name"});let i=(o=this.plugin.settings.modelContextLengths)==null?void 0:o[e];i&&s.createDiv({text:`\u{1F4CF} ${Math.round(i/1e3)}k`,cls:"or-saved-item-ctx"});let a=t.createDiv({cls:"or-saved-item-remove clickable-icon",attr:{"aria-label":"Remove"}});(0,p.setIcon)(a,"cross"),a.addEventListener("click",l=>{l.stopPropagation(),this.toggleFavorite(e)}),t.addEventListener("click",()=>this.selectModel(e))})}toggleFavorite(e){if(this.favorites.includes(e))this.favorites=this.favorites.filter(t=>t!==e),this.plugin.removeFavorite(e);else{this.favorites.push(e);let t=this.models.find(s=>s.id===e);this.plugin.addFavorite(e,(t==null?void 0:t.context_length)||null),this.pluginId&&this.pluginId!=="settings"&&(this.plugin.setModel(this.pluginId,e),console.log("Also set as plugin model:",this.pluginId,"->",e))}this.renderSaved(),new p.Notice(this.favorites.includes(e)?"Saved model":"Removed model")}selectModel(e){console.log("selectModel called:",e,"pluginId:",this.pluginId),this.plugin.setModel(this.pluginId,e),this.onSelect(e),this.close(),new p.Notice(`Selected: ${e.split("/").pop()}`)}onClose(){this.contentEl.empty(),this.modalEl.removeClass("or-modal")}};var v=require("obsidian"),x=class extends v.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.addClass("or-settings"),e.createEl("h2",{text:"OpenRouter Provider"}),new v.Setting(e).setName("API Key").setDesc("Your OpenRouter API key (shared across all AI plugins)").addText(s=>s.setPlaceholder("sk-or-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings()}));let t=e.createDiv({cls:"or-settings-balance"});t.setText("Checking balance..."),this.plugin.fetchCredits().then(s=>{t.empty();let i=t.createSpan({cls:"or-balance-icon"});(0,v.setIcon)(i,"wallet"),t.createSpan({text:s?`Balance: $${s}`:"Balance: Unknown"})}),this.createSection(e,"Connected Plugins","plug",()=>{let s=e.createDiv({cls:"or-settings-section-content"}),i=[{id:"ai-ocr-formatter",name:"AI OCR Formatter"},{id:"ai-flashcards",name:"AI Flashcards"},{id:"lecture-slides",name:"Lecture Slides"}],a=this.plugin.settings.pluginModels||{},o=!1;i.forEach(({id:l,name:c})=>{if(!this.app.plugins.getPlugin(l))return;o=!0;let n=s.createDiv({cls:"or-settings-plugin-row"}),r=n.createDiv({cls:"or-settings-plugin-info"}),g=r.createSpan({cls:"or-status-icon connected"});(0,v.setIcon)(g,"check-circle"),r.createSpan({text:c,cls:"or-settings-plugin-name"});let f=n.createDiv({cls:"or-settings-plugin-model"}),b=a[l];b?f.createSpan({text:b.split("/").pop()||b}):f.createSpan({text:"No model set",cls:"or-text-muted"})}),o||s.createDiv({text:"No AI plugins detected",cls:"or-text-muted or-text-center"})}),this.createSection(e,"Favorite Models","star",()=>{let s=e.createDiv({cls:"or-settings-section-content"}),i=this.plugin.getFavorites();i.length===0?s.createDiv({text:'No favorites saved yet. Use "Manage Models" to add some.',cls:"or-text-muted or-text-center"}):i.forEach(l=>{let c=l.split("/"),d=c.length>1?c[0]:"",n=c.length>1?c.slice(1).join("/"):l,r=s.createDiv({cls:"or-settings-model-row"});r.createSpan({text:n,cls:"or-settings-model-name"}),d&&r.createSpan({text:d,cls:"or-settings-model-provider"})}),s.createDiv({cls:"or-settings-btn-container"}).createEl("button",{text:"Manage Models",cls:"mod-cta"}).addEventListener("click",()=>{this.plugin.openModelSelector("settings",()=>{this.display()})})}),this.createCollapsibleSection(e,"Debug Info","bug",!1,()=>{let s=e.createDiv({cls:"or-settings-debug"}),i=this.plugin.settings.pluginModels||{};s.createDiv({text:"Raw pluginModels:",cls:"or-debug-label"}),s.createEl("pre",{text:JSON.stringify(i,null,2),cls:"or-debug-json"}),s.createDiv({text:"Favorites array:",cls:"or-debug-label"}),s.createEl("pre",{text:JSON.stringify(this.plugin.settings.favoriteModels,null,2),cls:"or-debug-json"})})}createSection(e,t,s,i){let o=e.createDiv({cls:"or-settings-section"}).createDiv({cls:"or-settings-section-header"}),l=o.createSpan({cls:"or-settings-section-icon"});(0,v.setIcon)(l,s),o.createSpan({text:t}),i()}createCollapsibleSection(e,t,s,i,a){let o=e.createDiv({cls:"or-settings-section or-collapsible"});i&&o.addClass("open");let l=o.createDiv({cls:"or-settings-section-header clickable"}),c=l.createSpan({cls:"or-settings-section-icon"});(0,v.setIcon)(c,s),l.createSpan({text:t});let d=l.createSpan({cls:"or-chevron"});(0,v.setIcon)(d,"chevron-down");let n=o.createDiv({cls:"or-collapsible-content"});l.addEventListener("click",()=>{o.toggleClass("open",!o.hasClass("open"))});let r=e;a();let g=e.lastElementChild;g&&g!==o&&n.appendChild(g)}};var k={apiKey:"",apiUrl:"https://openrouter.ai/api/v1/chat/completions",favoriteModels:["google/gemini-2.0-flash-exp:free","openai/gpt-4o-mini","anthropic/claude-3-haiku"],modelContextLengths:{},pluginModels:{}},y=class extends u.Plugin{async onload(){await this.loadSettings(),window.openrouterProvider=this,this.addSettingTab(new x(this.app,this)),this.addCommand({id:"open-settings",name:"Open OpenRouter Settings",callback:()=>{this.app.setting.open(),this.app.setting.openTabById("openrouter-provider")}}),console.log("OpenRouter Provider loaded")}onunload(){delete window.openrouterProvider}getApiKey(){return this.settings.apiKey}async setApiKey(e){this.settings.apiKey=e,await this.saveSettings()}getModel(e){return this.settings.pluginModels[e]||this.settings.favoriteModels[0]||"google/gemini-2.0-flash-exp:free"}async setModel(e,t){this.settings.pluginModels[e]=t,await this.saveSettings(),console.log("Plugin model saved:",e,"->",t,"All:",this.settings.pluginModels)}getFavorites(){return this.settings.favoriteModels||[]}async addFavorite(e,t=null){let s=this.settings.favoriteModels;s.indexOf(e)===-1&&s.push(e),t&&(this.settings.modelContextLengths[e]=t),await this.saveSettings(),console.log("Favorites saved:",this.settings.favoriteModels)}async removeFavorite(e){this.settings.favoriteModels=this.settings.favoriteModels.filter(t=>t!==e),await this.saveSettings(),console.log("Favorites after remove:",this.settings.favoriteModels)}async fetchCredits(){var e,t,s,i;if(!this.settings.apiKey)return null;try{let[a,o]=await Promise.all([(0,u.requestUrl)({url:"https://openrouter.ai/api/v1/credits",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}}),(0,u.requestUrl)({url:"https://openrouter.ai/api/v1/auth/key",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}})]),l=0;a.status===200&&(l=((t=(e=a.json)==null?void 0:e.data)==null?void 0:t.total_credits)||0);let c=1/0;return o.status===200&&((i=(s=o.json)==null?void 0:s.data)==null?void 0:i.limit)!==null&&(c=Math.max(0,(o.json.data.limit||0)-(o.json.data.usage||0))),Math.min(l,c).toFixed(2)}catch(a){return console.error("Failed to fetch credits",a),null}}openModelSelector(e,t){new m(this.app,this,e,t).open()}async fetchWithRetry(e,t=3,s=2e3){var i,a,o,l,c;for(let d=0;d<t;d++)try{let n=await(0,u.requestUrl)({url:this.settings.apiUrl,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Obsidian OpenRouter Provider"},body:JSON.stringify(e)});if(n.status===429){new u.Notice(`\u26A0\uFE0F Rate limit! Waiting ${s/1e3}s...`),await new Promise(r=>setTimeout(r,s)),s*=2;continue}if(n.status>=400){let r=`API Error ${n.status}`;try{let g=n.json;(i=g==null?void 0:g.error)!=null&&i.message&&(r+=`: ${g.error.message}`)}catch(g){}throw new Error(r)}return(c=(l=(o=(a=n.json)==null?void 0:a.choices)==null?void 0:o[0])==null?void 0:l.message)!=null&&c.content&&(n.json.choices[0].message.content=n.json.choices[0].message.content.replace(/<think>[\s\S]*?<\/think>/gi,"").trim()),n}catch(n){if(d===t-1)throw n;await new Promise(r=>setTimeout(r,s)),s*=1.5}}async loadSettings(){this.settings=Object.assign({},k,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
