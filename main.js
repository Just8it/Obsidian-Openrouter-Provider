var L=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var H=(g,e)=>{for(var t in e)L(g,t,{get:e[t],enumerable:!0})},K=(g,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of N(e))!j.call(g,i)&&i!==t&&L(g,i,{get:()=>e[i],enumerable:!(s=$(e,i))||s.enumerable});return g};var G=g=>K(L({},"__esModule",{value:!0}),g);var _={};H(_,{default:()=>P});module.exports=G(_);var f=require("obsidian");var u=require("obsidian"),E=class extends u.Modal{constructor(e,t,s,i){super(e),this.plugin=t,this.pluginId=s,this.onSelect=i,this.models=[],this.filteredModels=[],this.favorites=[...t.settings.favoriteModels||[]],this.balance="Loading...",this.filters={search:"",modality:"any",provider:[],context:"any",maxPrice:10}}async onOpen(){this.modalEl.addClass("or-modal"),this.plugin.fetchCredits().then(a=>{this.balance=a?`$${a}`:"Unknown",this.balanceEl&&this.balanceEl.setText(`Balance: ${this.balance}`)});let{contentEl:e}=this;e.empty();let t=e.createDiv({cls:"or-container"}),s=t.createDiv({cls:"or-sidebar"});s.createEl("h3",{text:"Select Model",cls:"or-sidebar-title"}),s.createDiv({text:this.pluginId,cls:"or-sidebar-subtitle"}),s.createEl("input",{cls:"or-search",attr:{placeholder:"Search models..."}}).addEventListener("input",a=>{this.filters.search=a.target.value.toLowerCase(),this.applyFilters()});let o=s.createDiv({cls:"or-filter-group"});o.createDiv({text:"Max Price ($/1M)",cls:"or-filter-label"});let r=o.createDiv({text:"$10.00",cls:"or-filter-value"});o.createEl("input",{type:"range",cls:"or-slider",attr:{min:"0",max:"10",step:"0.1",value:"10"}}).addEventListener("input",a=>{this.filters.maxPrice=parseFloat(a.target.value),r.setText(this.filters.maxPrice>=10?"$10.00+":`$${this.filters.maxPrice.toFixed(2)}`),this.applyFilters()}),this.createAccordion(s,"Modalities",[{label:"Text",value:"text"},{label:"Image (Vision)",value:"image"}],"modality",!0),this.createAccordion(s,"Providers",[{label:"OpenAI",value:"openai"},{label:"Anthropic",value:"anthropic"},{label:"Google",value:"google"},{label:"Mistral",value:"mistral"},{label:"Meta (Llama)",value:"meta"}],"provider",!1),this.createAccordion(s,"Context Length",[{label:"Any",value:"any",checked:!0},{label:"32k+",value:"32k"},{label:"128k+",value:"128k"}],"context",!0);let c=t.createDiv({cls:"or-catalog"}),d=c.createDiv({cls:"or-catalog-header"});this.countSpan=d.createSpan({text:"Loading...",cls:"or-catalog-title"}),this.balanceEl=d.createDiv({text:"Balance: ...",cls:"or-balance"}),this.modelList=c.createDiv({cls:"or-model-list"});let n=t.createDiv({cls:"or-saved"});n.createDiv({text:"MY SAVED MODELS",cls:"or-saved-title"}),n.addEventListener("dragover",a=>{a.preventDefault(),n.addClass("drag-over")}),n.addEventListener("dragleave",a=>{a.preventDefault(),n.removeClass("drag-over")}),n.addEventListener("drop",a=>{var v;a.preventDefault(),n.removeClass("drag-over");let p=(v=a.dataTransfer)==null?void 0:v.getData("text/plain");p&&!this.favorites.includes(p)?this.toggleFavorite(p):p&&new u.Notice("Model already in favorites")}),this.savedList=n.createDiv({cls:"or-saved-list"}),this.renderSaved(),this.fetchModels()}createAccordion(e,t,s,i,o){let r=e.createDiv({cls:"or-accordion open"}),l=r.createDiv({cls:"or-accordion-header"});l.createSpan({text:t}),l.innerHTML+='<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>',l.addEventListener("click",()=>r.classList.toggle("open"));let c=r.createDiv({cls:"or-accordion-body"});s.forEach(d=>{let n=c.createEl("label",{cls:"or-checkbox-row"}),a=n.createEl("input",{type:o?"radio":"checkbox",attr:{name:i}});d.checked&&(a.checked=!0),n.createSpan({text:d.label}),a.addEventListener("change",()=>{if(o)this.filters[i]=d.value;else{let p=this.filters[i];a.checked?p.push(d.value):this.filters[i]=p.filter(v=>v!==d.value)}this.applyFilters()})})}async fetchModels(){try{let e=await(0,u.requestUrl)({url:"https://openrouter.ai/api/v1/models",method:"GET"});e.status===200?(this.models=e.json.data,this.applyFilters()):new u.Notice("Failed to fetch models")}catch(e){console.error(e),new u.Notice("Error fetching models: "+e.message)}}applyFilters(){this.filteredModels=this.models.filter(e=>{if(this.filters.search&&!e.id.toLowerCase().includes(this.filters.search)&&!e.name.toLowerCase().includes(this.filters.search)||this.filters.modality==="image"&&!(e.id.includes("vision")||e.id.includes("gpt-4-turbo")||e.id.includes("claude-3"))||this.filters.provider.length>0&&!this.filters.provider.some(s=>e.id.startsWith(s)))return!1;if(this.filters.context!=="any"){let t=e.context_length||0;if(this.filters.context==="32k"&&t<32e3||this.filters.context==="128k"&&t<128e3)return!1}return!(this.filters.maxPrice<10&&(e.pricing?parseFloat(e.pricing.prompt)*1e6:0)>this.filters.maxPrice)}),this.countSpan.setText(`${this.filteredModels.length} Models`),this.renderCatalog()}renderCatalog(){this.modelList.empty(),this.filteredModels.slice(0,100).forEach(t=>{let s=this.modelList.createDiv({cls:"or-model-card"});s.setAttribute("draggable","true"),s.addEventListener("dragstart",n=>{var a;(a=n.dataTransfer)==null||a.setData("text/plain",t.id),n.dataTransfer&&(n.dataTransfer.effectAllowed="copy"),s.addClass("dragging")}),s.addEventListener("dragend",()=>s.removeClass("dragging"));let i=s.createDiv({cls:"or-model-info"}),o=i.createDiv({cls:"or-model-name"});o.createSpan({text:t.name}),(t.id.includes("vision")||t.id.includes("gemini")||t.id.includes("claude-3"))&&o.createSpan({text:"\u{1F441}\uFE0F",attr:{title:"Multimodal"}});let r=i.createDiv({cls:"or-model-meta"});if(r.createSpan({text:t.context_length?Math.round(t.context_length/1e3)+"k":"?"}),t.id.endsWith(":free"))r.createSpan({text:"FREE",cls:"or-tag-free"});else{let n=t.pricing?(parseFloat(t.pricing.prompt)*1e6).toFixed(2):"?";r.createSpan({text:`$${n}/M`,cls:"or-tag-paid"})}i.createDiv({text:t.id,cls:"or-model-id"}),i.addEventListener("click",()=>this.selectModel(t.id));let c=this.favorites.includes(t.id),d=s.createSpan({text:c?"\u2B50":"\u2606",cls:"or-fav-btn",attr:{title:c?"Remove from Favorites":"Add to Favorites"}});d.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")}),s.addEventListener("contextmenu",n=>{n.preventDefault(),this.toggleFavorite(t.id),d.setText(this.favorites.includes(t.id)?"\u2B50":"\u2606")})})}renderSaved(){this.savedList.empty(),this.favorites.forEach(e=>{var r;let t=this.savedList.createDiv({cls:"or-saved-item"}),s=t.createDiv();s.createDiv({text:e.split("/").pop()||e,cls:"or-saved-item-name"});let i=(r=this.plugin.settings.modelContextLengths)==null?void 0:r[e];i&&s.createDiv({text:`\u{1F4CF} ${Math.round(i/1e3)}k`,cls:"or-saved-item-ctx"});let o=t.createDiv({cls:"or-saved-item-remove clickable-icon",attr:{"aria-label":"Remove"}});(0,u.setIcon)(o,"cross"),o.addEventListener("click",l=>{l.stopPropagation(),this.toggleFavorite(e)}),t.addEventListener("click",()=>this.selectModel(e))})}toggleFavorite(e){if(this.favorites.includes(e))this.favorites=this.favorites.filter(t=>t!==e),this.plugin.removeFavorite(e);else{this.favorites.push(e);let t=this.models.find(s=>s.id===e);this.plugin.addFavorite(e,(t==null?void 0:t.context_length)||null),this.pluginId&&this.pluginId!=="settings"&&(this.plugin.setModel(this.pluginId,e),console.log("Also set as plugin model:",this.pluginId,"->",e))}this.renderSaved(),new u.Notice(this.favorites.includes(e)?"Saved model":"Removed model")}selectModel(e){console.log("selectModel called:",e,"pluginId:",this.pluginId),this.plugin.setModel(this.pluginId,e),this.onSelect(e),this.close(),new u.Notice(`Selected: ${e.split("/").pop()}`)}onClose(){this.contentEl.empty(),this.modalEl.removeClass("or-modal")}};var m=require("obsidian"),w=class extends m.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.addClass("or-settings"),e.createEl("h2",{text:"OpenRouter Provider"}),new m.Setting(e).setName("API Key").setDesc("Your OpenRouter API key (shared across all AI plugins)").addText(s=>s.setPlaceholder("sk-or-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings()}));let t=e.createDiv({cls:"or-settings-balance"});t.setText("Checking balance..."),this.plugin.fetchCredits().then(s=>{t.empty();let i=t.createSpan({cls:"or-balance-icon"});(0,m.setIcon)(i,"wallet"),t.createSpan({text:s?`Balance: $${s}`:"Balance: Unknown"})}),this.createSection(e,"Connected Plugins","plug",()=>{let s=e.createDiv({cls:"or-settings-section-content"}),i=[{id:"ai-ocr-formatter",name:"AI OCR Formatter"},{id:"ai-flashcards",name:"AI Flashcards"},{id:"lecture-slides",name:"Lecture Slides"}],o=this.plugin.settings.pluginModels||{},r=!1;i.forEach(({id:l,name:c})=>{if(!this.app.plugins.getPlugin(l))return;r=!0;let n=s.createDiv({cls:"or-settings-plugin-row"}),a=n.createDiv({cls:"or-settings-plugin-info"}),p=a.createSpan({cls:"or-status-icon connected"});(0,m.setIcon)(p,"check-circle"),a.createSpan({text:c,cls:"or-settings-plugin-name"});let v=n.createDiv({cls:"or-settings-plugin-model"}),h=o[l];h?v.createSpan({text:h.split("/").pop()||h}):v.createSpan({text:"No model set",cls:"or-text-muted"})}),r||s.createDiv({text:"No AI plugins detected",cls:"or-text-muted or-text-center"})}),this.createSection(e,"Favorite Models","star",()=>{let s=e.createDiv({cls:"or-settings-section-content"}),i=this.plugin.getFavorites();i.length===0?s.createDiv({text:'No favorites saved yet. Use "Manage Models" to add some.',cls:"or-text-muted or-text-center"}):i.forEach(l=>{let c=l.split("/"),d=c.length>1?c[0]:"",n=c.length>1?c.slice(1).join("/"):l,a=s.createDiv({cls:"or-settings-model-row"});a.createSpan({text:n,cls:"or-settings-model-name"}),d&&a.createSpan({text:d,cls:"or-settings-model-provider"})}),s.createDiv({cls:"or-settings-btn-container"}).createEl("button",{text:"Manage Models",cls:"mod-cta"}).addEventListener("click",()=>{this.plugin.openModelSelector("settings",()=>{this.display()})})}),this.createCollapsibleSection(e,"Debug Info","bug",!1,()=>{let s=e.createDiv({cls:"or-settings-debug"}),i=this.plugin.settings.pluginModels||{};s.createDiv({text:"Raw pluginModels:",cls:"or-debug-label"}),s.createEl("pre",{text:JSON.stringify(i,null,2),cls:"or-debug-json"}),s.createDiv({text:"Favorites array:",cls:"or-debug-label"}),s.createEl("pre",{text:JSON.stringify(this.plugin.settings.favoriteModels,null,2),cls:"or-debug-json"})})}createSection(e,t,s,i){let r=e.createDiv({cls:"or-settings-section"}).createDiv({cls:"or-settings-section-header"}),l=r.createSpan({cls:"or-settings-section-icon"});(0,m.setIcon)(l,s),r.createSpan({text:t}),i()}createCollapsibleSection(e,t,s,i,o){let r=e.createDiv({cls:"or-settings-section or-collapsible"});i&&r.addClass("open");let l=r.createDiv({cls:"or-settings-section-header clickable"}),c=l.createSpan({cls:"or-settings-section-icon"});(0,m.setIcon)(c,s),l.createSpan({text:t});let d=l.createSpan({cls:"or-chevron"});(0,m.setIcon)(d,"chevron-down");let n=r.createDiv({cls:"or-collapsible-content"});l.addEventListener("click",()=>{r.toggleClass("open",!r.hasClass("open"))});let a=e;o();let p=e.lastElementChild;p&&p!==r&&n.appendChild(p)}};var T=class{static async streamRequest(e,t,s,i,o,r,l=new AbortController){var c,d,n,a,p,v;try{let h=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Obsidian OpenRouter Provider"},body:JSON.stringify({...s,stream:!0}),signal:l.signal});if(!h.ok){let S=`API Error ${h.status}`;try{let y=await h.json();(c=y==null?void 0:y.error)!=null&&c.message&&(S+=`: ${y.error.message}`)}catch(y){S+=`: ${h.statusText}`}throw new Error(S)}if(!h.body)throw new Error("No response body");let R=h.body.getReader(),O=new TextDecoder("utf-8"),I="",k="";for(;;){let{done:S,value:y}=await R.read();if(S)break;let B=O.decode(y,{stream:!0});k+=B;let F=k.split(`
`);k=F.pop()||"";for(let A of F){let b=A.trim();if(!(!b||b==="data: [DONE]")&&b.startsWith("data: "))try{let M=JSON.parse(b.slice(6)),C=(a=(n=(d=M.choices)==null?void 0:d[0])==null?void 0:n.delta)==null?void 0:a.content;C&&(I+=C,i(C)),(v=(p=M.choices)==null?void 0:p[0])!=null&&v.finish_reason}catch(M){console.warn("Failed to parse SSE line:",A,M)}}}r(I)}catch(h){h.name==="AbortError"?console.log("Stream aborted"):(console.error("Stream Error:",h),o(h))}}};var x=require("obsidian"),D=class{constructor(e){this.startTime=0;this.tokenCount=0;this.item=e,this.reset()}reset(){this.item.empty(),this.item.style.display="none",this.stopSpinner(),this.startTime=0,this.tokenCount=0}setConnecting(){this.item.style.display="inline-flex",this.item.empty();let e=this.item.createSpan({cls:"status-bar-item-icon"});(0,x.setIcon)(e,"rss"),this.item.createSpan({text:" Connecting..."})}setThinking(){this.item.style.display="inline-flex",this.item.empty();let e=this.item.createSpan({cls:"status-bar-item-icon"});(0,x.setIcon)(e,"brain-circuit"),this.item.createSpan({text:" Thinking..."}),this.startSpinner()}setGenerating(){this.startTime===0&&(this.startTime=Date.now()),this.item.style.display="inline-flex",this.item.empty();let e=this.item.createSpan({cls:"status-bar-item-icon"});(0,x.setIcon)(e,"zap");let t=this.calculateSpeed(),s=t>0?` (${t} t/s)`:"";this.item.createSpan({text:` Generating...${s}`})}updateProgress(e){this.tokenCount+=e,this.setGenerating()}setSuccess(){this.stopSpinner(),this.item.empty();let e=this.item.createSpan({cls:"status-bar-item-icon"});(0,x.setIcon)(e,"check"),this.item.createSpan({text:" Done"}),setTimeout(()=>this.reset(),3e3)}setError(e){this.stopSpinner(),this.item.empty();let t=this.item.createSpan({cls:"status-bar-item-icon"});(0,x.setIcon)(t,"alert-triangle"),this.item.createSpan({text:" Error"}),this.item.title=e,setTimeout(()=>this.reset(),5e3)}calculateSpeed(){if(this.startTime===0||this.tokenCount===0)return 0;let e=(Date.now()-this.startTime)/1e3;return e>0?Math.round(this.tokenCount/e):0}startSpinner(){}stopSpinner(){this.spinnerInterval&&(clearInterval(this.spinnerInterval),this.spinnerInterval=null)}};var U={apiKey:"",apiUrl:"https://openrouter.ai/api/v1/chat/completions",favoriteModels:["google/gemini-2.0-flash-exp:free","openai/gpt-4o-mini","anthropic/claude-3-haiku"],modelContextLengths:{},pluginModels:{}},P=class extends f.Plugin{async onload(){await this.loadSettings(),window.openrouterProvider=this;let e=this.addStatusBarItem();this.statusBar=new D(e),this.addSettingTab(new w(this.app,this)),this.addCommand({id:"open-settings",name:"Open OpenRouter Settings",callback:()=>{this.app.setting.open(),this.app.setting.openTabById("openrouter-provider")}}),console.log("OpenRouter Provider loaded")}onunload(){delete window.openrouterProvider,this.statusBar&&this.statusBar.reset()}async loadSettings(){this.settings=Object.assign({},U,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getApiKey(){return this.settings.apiKey}async setApiKey(e){this.settings.apiKey=e,await this.saveSettings()}getModel(e){return this.settings.pluginModels[e]||this.settings.favoriteModels[0]||"google/gemini-2.0-flash-exp:free"}async setModel(e,t){this.settings.pluginModels[e]=t,await this.saveSettings(),console.log("Plugin model saved:",e,"->",t,"All:",this.settings.pluginModels)}getFavorites(){return this.settings.favoriteModels||[]}async addFavorite(e,t=null){let s=this.settings.favoriteModels;s.includes(e)||s.push(e),t&&(this.settings.modelContextLengths[e]=t),await this.saveSettings(),console.log("Favorites saved:",this.settings.favoriteModels)}async removeFavorite(e){this.settings.favoriteModels=this.settings.favoriteModels.filter(t=>t!==e),await this.saveSettings(),console.log("Favorites after remove:",this.settings.favoriteModels)}async fetchCredits(){var e,t,s,i;if(!this.settings.apiKey)return null;try{let[o,r]=await Promise.all([(0,f.requestUrl)({url:"https://openrouter.ai/api/v1/credits",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}}),(0,f.requestUrl)({url:"https://openrouter.ai/api/v1/auth/key",method:"GET",headers:{Authorization:`Bearer ${this.settings.apiKey}`}})]),l=0;o.status===200&&(l=((t=(e=o.json)==null?void 0:e.data)==null?void 0:t.total_credits)||0);let c=1/0;return r.status===200&&((i=(s=r.json)==null?void 0:s.data)==null?void 0:i.limit)!==null&&(c=Math.max(0,(r.json.data.limit||0)-(r.json.data.usage||0))),Math.min(l,c).toFixed(2)}catch(o){return console.error("Failed to fetch credits",o),null}}openModelSelector(e,t){new E(this.app,this,e,t).open()}async fetchWithRetry(e,t=3,s=2e3){var i,o,r,l,c;this.statusBar.setConnecting();for(let d=0;d<t;d++)try{this.statusBar.setGenerating();let n=await(0,f.requestUrl)({url:this.settings.apiUrl,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Obsidian OpenRouter Provider"},body:JSON.stringify(e)});if(n.status===429){new f.Notice(`\u26A0\uFE0F Rate limit! Waiting ${s/1e3}s...`),this.statusBar.item.setText(` Rate limited (${s/1e3}s)`),await new Promise(a=>setTimeout(a,s)),s*=2;continue}if(n.status>=400){let a=`API Error ${n.status}`;try{let p=n.json;(i=p==null?void 0:p.error)!=null&&i.message&&(a+=`: ${p.error.message}`)}catch(p){}throw new Error(a)}return(c=(l=(r=(o=n.json)==null?void 0:o.choices)==null?void 0:r[0])==null?void 0:l.message)!=null&&c.content&&(n.json.choices[0].message.content=n.json.choices[0].message.content.replace(/<think>[\s\S]*?<\/think>/gi,"").trim()),this.statusBar.setSuccess(),n}catch(n){if(d===t-1)throw this.statusBar.setError("API Failed"),n;await new Promise(a=>setTimeout(a,s)),s*=1.5}}async streamRequest(e,t,s,i){let o=this.settings.apiKey;if(!o){new f.Notice("OpenRouter API Key missing!");return}this.statusBar.setConnecting(),(e.model.includes("deepseek")||e.model.includes("reasoner"))&&this.statusBar.setThinking(),await T.streamRequest(this.settings.apiUrl,o,e,r=>{this.statusBar.updateProgress(1),t(r)},r=>{this.statusBar.setError("Stream Error"),i(r)},r=>{this.statusBar.setSuccess(),s(r)})}};
